<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Finanzas</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="/guard.js" defer></script>
</head>

<body data-page="finanzas">
    <div data-include="/partials/topbar2.html"></div>

    <div class="container">
        <div class="card">
            <h2>Finanzas</h2>
            <div class="muted" id="cicloInfo">Cargando ciclo…</div>
            <p class="helper" id="cutoffInfo" style="margin-top:6px"></p>
            <div class="row-3" style="margin-top:10px">
                <div class="card">
                    <div class="muted">Deuda consolidada</div>
                    <div style="font-size:18px" id="kpiTotal">$0.00</div>
                </div>
                <div class="card">
                    <div class="muted">Alumnos con deuda</div>
                    <div style="font-size:18px" id="kpiAlumnos">0</div>
                </div>
                <div class="card">
                    <div class="muted">Periodos vencidos</div>
                    <div style="font-size:18px" id="kpiPeriodos">—</div>
                </div>
            </div>
        </div>

        <div class="row-2 mt-12">
            <div class="card">
                <h3 style="margin:0 0 10px">Deuda por nivel</h3>
                <div id="nivelList" class="list"></div>
            </div>
            <div class="card">
                <h3 style="margin:0 0 10px">Deuda por periodo</h3>
                <div id="periodoList" class="list"></div>
            </div>
        </div>

        <div class="card mt-12">
            <div class="row-2" style="align-items:center">
                <h3 style="margin:0">Alumnos con deuda</h3>
                <!-- reemplazo del filtro: selector de orden -->
                <div style="justify-self:end">
                    <label for="orden" class="subtle" style="display:block;margin-bottom:4px">Ordenar por</label>
                    <select id="orden" class="input" style="height:auto;padding:8px 10px">
                        <option value="nivel" style="font-size: 40px">Grado</option>
                        <option value="cantidad" style="font-size: 40px">Cantidad</option>
                        <!--<option value="nombre">Nombre (A→Z)</option>-->
                    </select>
                </div>
            </div>

            <div class="table" style="margin-top:8px">
                <table style="width:100%">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Nivel</th>
                            <th>Grado</th>
                            <th>Conceptos</th>
                            <th class="t-right">Cantidad</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyDeudores"></tbody>
                </table>
            </div>
            <div class="muted mt-8" id="resumenRows"></div>
        </div>
    </div>

    <script src="/include.js" defer></script>
    <script src="/topbar-init.js" defer></script>
    <script src="/utils.js" defer></script>
    <script>
        const $id = (x) => document.getElementById(x);
        const fmt = (n) => (window.fmtMXN ? fmtMXN(n) : ('$' + Number(n || 0).toFixed(2)));

        async function getCicloActual() {
            const r = await fetch('/api/param?keys=ciclo_actual');
            const j = await r.json().catch(() => ({}));
            return j?.ciclo_actual || '';
        }

        async function fetchJson(url) {
            const r = await fetch(url, { credentials: 'same-origin' });
            const t = await r.text();
            let j = {};
            try { j = JSON.parse(t); } catch { }
            if (!r.ok) throw new Error(j.error || ('HTTP ' + r.status + ' ' + t));
            return j;
        }

        // “Etiqueta: $X,XXX.XX” en una línea
        function renderList(el, pairs) {
            el.innerHTML = pairs.length
                ? pairs.map(([k, v]) => `<div class="list-row">${k}: ${fmt(v)}</div>`).join('')
                : '<div class="helper">Sin datos.</div>';
        }

        // Ordenamientos
        const nivelOrderMap = new Map([
            ['Preescolar', 0],
            ['Kinder', 0],   // alias por si acaso
            ['Primaria', 1],
            ['Secundaria', 2],
            ['Bachillerato', 3],
        ]);
        const nivelRank = (s) => nivelOrderMap.has(s) ? nivelOrderMap.get(s) : 99;
        const gradoNum = (g) => {
            const n = parseInt(g, 10);
            return Number.isFinite(n) ? n : 99; // grados vacíos al final
        };

        function sortRows(rows, mode) {
            const collator = new Intl.Collator('es');
            if (mode === 'cantidad') {
                return [...rows].sort((a, b) => (b.cantidad || 0) - (a.cantidad || 0));
            }
            if (mode === 'nombre') {
                return [...rows].sort((a, b) => collator.compare(a.nombre || '', b.nombre || ''));
            }
            // default: nivel → grado → nombre
            return [...rows].sort((a, b) => {
                const nA = nivelRank(a.nivel || '');
                const nB = nivelRank(b.nivel || '');
                if (nA !== nB) return nA - nB;
                const gA = gradoNum(a.grado);
                const gB = gradoNum(b.grado);
                if (gA !== gB) return gA - gB;
                return collator.compare(a.nombre || '', b.nombre || '');
            });
        }

        function renderTable(rows) {
            const tbody = $id('tbodyDeudores');
            tbody.innerHTML = rows.map(r => `
        <tr onclick="window.open('/padres/perfil.html?id=${encodeURIComponent(r.id)}','_blank')" style="cursor:pointer">
          <td>${r.nombre}</td>
          <td>${r.nivel}</td>
          <td>${r.grado ?? ''}</td>
          <td>${r.conceptos}</td>
          <td class="t-right">${fmt(r.cantidad)}</td>
        </tr>
      `).join('');
            $id('resumenRows').textContent = `${rows.length} alumno(s) con deuda`;
        }

        async function init() {
            const ciclo = await getCicloActual();
            $id('cicloInfo').textContent = ciclo ? `Ciclo actual: ${ciclo}` : 'Configura el parámetro ciclo_actual.';
            if (!ciclo) return;

            const [ov, deud] = await Promise.all([
                fetchJson('/api/finanzas/overview?ciclo=' + encodeURIComponent(ciclo)),
                fetchJson('/api/finanzas/deudores?ciclo=' + encodeURIComponent(ciclo)),
            ]);

            // KPIs
            $id('cutoffInfo').textContent = `Corte: ${ov.fecha_corte}`;
            $id('kpiTotal').textContent = fmt(ov.total_deuda);
            $id('kpiAlumnos').textContent = ov.alumnos_con_deuda;
            $id('kpiPeriodos').textContent = (ov.periodos_vencidos || []).join(', ') || '—';

            // Por nivel / periodo
            renderList($id('nivelList'), (ov.por_nivel || []).map(x => [x.nivel, x.monto]));
            renderList($id('periodoList'), (ov.por_periodo || []).map(x => [x.periodo, x.monto]));

            // Deudores (sin filtro por nombre; orden por defecto nivel→grado→nombre)
            const baseRows = Array.isArray(deud.deudores) ? deud.deudores : [];
            const select = $id('orden');

            const applySort = () => {
                const mode = select.value || 'nivel';
                const sorted = sortRows(baseRows, mode);
                renderTable(sorted);
            };

            select.addEventListener('change', applySort);
            applySort(); // render inicial
        }

        document.addEventListener('DOMContentLoaded', () => {
            init().catch(e => {
                console.error('finanzas init error:', e);
                alert('Error cargando finanzas. Revisa consola.');
            });
        });
    </script>
</body>

</html>